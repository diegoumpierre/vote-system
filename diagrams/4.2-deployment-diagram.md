# 4.2 Deployment Diagram

AWS multi-region infrastructure (3 regions) to handle **250k RPS** peak. Writes centralized in US-East-1; reads from local replicas.

```mermaid
flowchart TB
    Users["Global Users (300M)"]

    subgraph Edge["Edge"]
        Route53["Route53<br/>Geo Routing"]
        WAF["WAF<br/>DDoS + Rate Limit"]
    end

    Users -->|API calls| Route53 --> WAF

    subgraph Region1["US-EAST-1 (Primary Region)"]
        APIGW1["API Gateway · 100k RPS<br/>JWT Authorizer (native)"]
        ALB1["ALBs"]

        subgraph ECS1["ECS on EC2 · 3 AZs"]
            Auth1["Auth Service"]
            Vote1["Vote Service"]
            Results1["Results Service"]
        end

        SQS1["SQS<br/>Vote Queue + DLQ"]
        RDS1[("RDS PostgreSQL<br/>Primary · Multi-AZ")]
        Redis1["Redis Cluster<br/>Cache + Dedup"]
    end

    subgraph Region2["EU-WEST-1"]
        APIGW2["API Gateway · 100k RPS"]
        ECS2["ECS on EC2<br/>Auth | Vote | Results"]
        SQS2["SQS"]
        RDS2[("RDS PostgreSQL<br/>Read Replica")]
        Redis2["Redis Cluster"]
    end

    subgraph Region3["AP-SOUTHEAST-1"]
        APIGW3["API Gateway · 100k RPS"]
        ECS3["ECS on EC2<br/>Auth | Vote | Results"]
        SQS3["SQS"]
        RDS3[("RDS PostgreSQL<br/>Read Replica")]
        Redis3["Redis Cluster"]
    end

    Auth0["Auth0 (External)"]

    %% Edge to regions
    WAF --> APIGW1
    WAF --> APIGW2
    WAF --> APIGW3

    %% Primary region flow
    APIGW1 --> ALB1 --> ECS1
    Vote1 --> SQS1 --> Vote1
    Vote1 --> RDS1
    Vote1 --> Redis1
    Results1 --> Redis1
    Results1 --> RDS1
    Auth1 --> Auth0
    Auth1 --> Redis1

    %% Secondary regions
    APIGW2 --> ECS2
    ECS2 --> SQS2
    ECS2 --> Redis2
    ECS2 -->|Reads| RDS2
    ECS2 -.->|Writes| RDS1

    APIGW3 --> ECS3
    ECS3 --> SQS3
    ECS3 --> Redis3
    ECS3 -->|Reads| RDS3
    ECS3 -.->|Writes| RDS1

    %% Replication
    RDS1 -.->|Async Replication| RDS2
    RDS1 -.->|Async Replication| RDS3

    %% Styling
    classDef data fill:#e8f5e9,stroke:#1b5e20
    classDef edge fill:#fff3e0,stroke:#e65100
    class RDS1,RDS2,RDS3,Redis1,Redis2,Redis3 data
    class APIGW1,APIGW2,APIGW3,ALB1 edge
```

---

## Regional Capacity

| Component | US-East-1 (Primary) | EU-West-1 | AP-Southeast-1 |
|-----------|---------------------|-----------|----------------|
| API Gateway | 100k RPS | 100k RPS | 100k RPS |
| EC2 Instances | 3-10 (m6i.2xlarge) | 3-10 | 3-10 |
| ECS Tasks (Vote) | 10-100 | 10-100 | 10-100 |
| RDS PostgreSQL | Primary (r6g.4xlarge) | Read Replica | Read Replica |
| Redis Cluster | 3 nodes | 3 nodes | 3 nodes |
| SQS | Unlimited | Unlimited | Unlimited |

---

## Deployment Decisions

| Decision | Why |
|----------|-----|
| **3 Regions** | API Gateway caps at 100k RPS/region. 3 x 100k = 300k capacity for 250k peak |
| **Route53 Geo Routing** | Users routed to closest region (lowest latency) |
| **Multi-AZ (3 AZs)** | ECS and RDS distributed across AZs for high availability |
| **Write to Primary only** | All votes write to US-East-1 RDS; avoids multi-master conflicts |
| **Read from local Replica** | EU and AP read from local RDS replicas for low-latency results |
| **ECS on EC2** | Fargate is serverless (restricted). EC2 allows Reserved Instances and zero cold start |
| **Native JWT Authorizer** | Lambda Authorizer is serverless (restricted). API Gateway validates JWT natively |

---

## Layer Details

### Edge
- **Route53**: Geolocation routing + health checks, failover in 30s
- **WAF**: DDoS protection, per-IP rate limiting, anti-bot rules
- **CloudFront**: CDN for React static assets (separate flow, not shown)

### Compute (per region)
- **API Gateway**: Throttling + native JWT Authorizer (Auth0 issuer/audience)
- **ALB**: Health checks, target group per service
- **ECS on EC2**: EC2 ASG (instance scaling) + ECS Service Auto Scaling (task scaling), target CPU 70%

### Data (per region)
- **RDS PostgreSQL**: Multi-AZ, automated backups, PITR
- **ElastiCache Redis**: Cluster mode — vote aggregates, deduplication, session cache
- **SQS**: Standard queue + DLQ for vote buffering and retry

### Observability (not shown, see section 9)
- **CloudWatch**: Logs, metrics, alarms
- **X-Ray**: Distributed tracing
- **Grafana**: Dashboards (CloudWatch datasource)

### Shared Services (not shown)
- **Secrets Manager**: Automatic credential rotation
- **ECR**: Container image registry
- **S3**: Audit logs (90 days → Glacier)
