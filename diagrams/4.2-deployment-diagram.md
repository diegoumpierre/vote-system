# 4.2 Deployment Diagram

The diagram below shows the AWS infrastructure distributed across **3 regions** (US-East, EU-West, AP-Southeast) to reach the **250k RPS** peak. Regions serve traffic locally with Route53 failover; writes are centralized in the primary region.

```mermaid
flowchart TB
    subgraph Internet["Internet"]
        Users["Global Users<br/>(300M potential)"]
        TVApp["TV Show App<br/>(React.js)"]
    end

    subgraph Edge["AWS Edge Services"]
        Route53["Route53<br/>DNS + Geo Routing<br/>+ Health Checks"]
        WAF["AWS WAF<br/>DDoS Protection<br/>Rate Limiting"]
        CloudFront["CloudFront<br/>Static Assets CDN"]
    end

    subgraph Auth0Cloud["Auth0 (External)"]
        Auth0["Auth0<br/>Identity Provider<br/>OAuth2/OIDC"]
    end

    Users --> TVApp
    TVApp --> Route53
    Route53 --> WAF
    WAF --> CloudFront

    subgraph Region1["US-EAST-1 (Primary)"]
        subgraph VPC1["VPC 10.0.0.0/16"]
            subgraph PublicSubnet1["Public Subnets (AZ-a, AZ-b, AZ-c)"]
                APIGW1["API Gateway<br/>100k RPS limit<br/>JWT Validation"]
                ALB1_Auth["ALB<br/>Auth Service"]
                ALB1_Vote["ALB<br/>Vote Service"]
                ALB1_Results["ALB<br/>Results Service"]
            end
            
            subgraph PrivateSubnet1["Private Subnets (AZ-a, AZ-b, AZ-c)"]
                subgraph ECS1["ECS Fargate Cluster"]
                    AuthSvc1["Auth Service<br/>3-10 tasks<br/>2 vCPU / 4GB"]
                    VoteSvc1["Vote Service<br/>10-100 tasks<br/>4 vCPU / 8GB"]
                    ResultsSvc1["Results Service<br/>5-30 tasks<br/>2 vCPU / 4GB"]
                end
                
                SQS1["SQS Queue<br/>Vote Buffer<br/>+ DLQ"]
            end
            
            subgraph DataSubnet1["Data Subnets (AZ-a, AZ-b)"]
                RDS1[("RDS PostgreSQL<br/>Primary<br/>db.r6g.4xlarge<br/>Multi-AZ")]
                Redis1["ElastiCache Redis<br/>Cluster Mode<br/>Vote Aggregates"]
            end
        end
    end

    subgraph Region2["EU-WEST-1"]
        subgraph VPC2["VPC 10.1.0.0/16"]
            APIGW2["API Gateway"]
            ALB2["ALBs"]
            ECS2["ECS Fargate<br/>Auth | Vote | Results"]
            SQS2["SQS Queue"]
            RDS2[("RDS PostgreSQL<br/>Read Replica")]
            Redis2["ElastiCache Redis"]
        end
    end

    subgraph Region3["AP-SOUTHEAST-1"]
        subgraph VPC3["VPC 10.2.0.0/16"]
            APIGW3["API Gateway"]
            ALB3["ALBs"]
            ECS3["ECS Fargate<br/>Auth | Vote | Results"]
            SQS3["SQS Queue"]
            RDS3[("RDS PostgreSQL<br/>Read Replica")]
            Redis3["ElastiCache Redis"]
        end
    end

    subgraph SharedServices["Shared Services"]
        SecretsManager["Secrets Manager<br/>DB Credentials<br/>API Keys"]
        CloudWatch["CloudWatch<br/>Logs + Metrics"]
        ECR["ECR<br/>Container Registry"]
        S3Audit["S3<br/>Audit Logs"]
    end

    subgraph Observability["Observability Stack"]
        Prometheus["Prometheus<br/>Metrics Collection"]
        Grafana["Grafana<br/>Dashboards"]
    end

    %% Edge to Regions
    WAF --> APIGW1
    WAF --> APIGW2
    WAF --> APIGW3

    %% Region 1 Flow
    APIGW1 --> ALB1_Auth --> AuthSvc1
    APIGW1 --> ALB1_Vote --> VoteSvc1
    APIGW1 --> ALB1_Results --> ResultsSvc1
    
    VoteSvc1 --> SQS1
    SQS1 --> VoteSvc1
    VoteSvc1 --> RDS1
    VoteSvc1 --> Redis1
    ResultsSvc1 --> Redis1
    ResultsSvc1 --> RDS1
    AuthSvc1 --> Auth0
    AuthSvc1 --> Redis1

    %% Region 2 Flow
    APIGW2 --> ALB2 --> ECS2
    ECS2 --> SQS2
    ECS2 -->|Reads| RDS2
    ECS2 --> Redis2
    ECS2 -.->|Writes| RDS1

    %% Region 3 Flow
    APIGW3 --> ALB3 --> ECS3
    ECS3 --> SQS3
    ECS3 -->|Reads| RDS3
    ECS3 --> Redis3
    ECS3 -.->|Writes| RDS1

    %% Cross-region replication
    RDS1 -.->|Async Replication| RDS2
    RDS1 -.->|Async Replication| RDS3

    %% Shared Services
    ECS1 --> SecretsManager
    ECS1 --> CloudWatch
    ECS1 --> S3Audit
    CloudWatch --> Prometheus --> Grafana

    %% Styling
    classDef primary fill:#e1f5fe,stroke:#01579b
    classDef secondary fill:#f3e5f5,stroke:#4a148c
    classDef data fill:#e8f5e9,stroke:#1b5e20
    classDef edge fill:#fff3e0,stroke:#e65100
    
    class RDS1,RDS2,RDS3,Redis1,Redis2,Redis3 data
    class APIGW1,APIGW2,APIGW3,ALB1_Auth,ALB1_Vote,ALB1_Results,ALB2,ALB3 edge
```

---

## Regional Capacity Legend

| Component | US-East-1 (Primary) | EU-West-1 | AP-Southeast-1 |
|------------|---------------------|-----------|----------------|
| API Gateway | 100k RPS | 100k RPS | 100k RPS |
| ECS Tasks (Vote) | 10-100 | 10-100 | 10-100 |
| RDS PostgreSQL | Primary (r6g.4xlarge) | Read Replica | Read Replica |
| Redis Cluster | 3 nodes | 3 nodes | 3 nodes |
| SQS Throughput | Unlimited | Unlimited | Unlimited |

---

## Deployment Decisions

| Decision | Description |
|---------|-----------|
| **Route53 Geolocation Routing** | Users are routed to the closest region |
| **Multi-AZ per region** | RDS and ECS are distributed across 3 AZs for HA |
| **Write to Primary** | All votes are written to RDS US-East-1 (primary) |
| **Read Replicas** | EU and AP read from local replicas for lower latency |

---

## Layer Details

### Edge Layer
- **Route53**: Geo-routing + health checks with automatic failover (30s detection)
- **WAF**: DDoS protection, per-IP rate limiting, anti-bot rules
- **CloudFront**: CDN for React app static assets

### Compute Layer (per region)
- **API Gateway**: Throttling, JWT validation via Lambda Authorizer
- **ALB**: Health checks, target groups per service
- **ECS Fargate**: Auto-scaling based on CPU/Memory (target 70%)

### Data Layer
- **RDS PostgreSQL**: Multi-AZ, automated backups, point-in-time recovery
- **ElastiCache Redis**: Cluster mode for vote aggregates and session cache
- **SQS**: Standard queue with DLQ for retry handling

### Shared Services
- **Secrets Manager**: Automatic credential rotation
- **CloudWatch**: Centralized logs, custom metrics
- **S3**: Audit logs with lifecycle policy (90 days â†’ Glacier)
