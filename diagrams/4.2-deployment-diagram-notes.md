# 4.2 Deployment Diagram — Notes

## Overview

3 AWS regions, 250k RPS peak. All writes go to US-East-1 (primary); reads served from local replicas.

**Why 3 regions?** API Gateway limit is 100k RPS/region. 3 × 100k = 300k capacity.

## Request Flow

```
User → Route53 (geo routing) → WAF (DDoS + rate limit) → API Gateway → ALB → ECS Service
```

- **Route53**: Routes user to nearest region. Health checks with 30s failover.
- **WAF**: DDoS protection, per-IP rate limiting.
- **API Gateway**: Throttling + native JWT validation (no Lambda).
- **ALB**: Distributes traffic to Auth, Vote, and Results services.

## Compute — ECS on EC2

3 services running as ECS tasks on EC2 instances (not Fargate — serverless is restricted):

- **Auth Service** → Integrates with Auth0 (external IdP)
- **Vote Service** → Validates duplicates in Redis, enqueues to SQS
- **Results Service** → Reads counts from Redis / PostgreSQL

Scaling: EC2 ASG (3–10 instances) + ECS Service Auto Scaling (10–100 tasks). Target CPU 70%.

## Data Stores

- **SQS** — Buffers votes between ingestion (250k RPS) and DB writes (~20-50k/s). DLQ for failed messages.
- **Redis** — Vote deduplication (SET with TTL), real-time counters (INCR), session cache.
- **RDS PostgreSQL** — Primary in US-East-1 (Multi-AZ). Read Replicas in EU and AP. UNIQUE constraint as final duplicate barrier.

## Cross-Region

- **Writes** (dashed red): All regions write to US-East-1 primary. No multi-master = no write conflicts.
- **Replication** (dashed blue): Async replication from primary to read replicas (~1s delay).

## Not Shown in Diagram

- CloudFront + S3 (static frontend) — separate flow
- CloudWatch, X-Ray, Grafana — see section 9
- Secrets Manager, ECR, S3 audit logs — shared services
