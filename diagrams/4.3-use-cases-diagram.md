# 4.3 Use Cases Diagram

The diagram below represents the main capabilities of the voting system, organized by actor.

```mermaid
flowchart LR
    subgraph Actors["Actors"]
        Viewer["Viewer<br/>(Audience)"]
        Admin["Admin<br/>(Backoffice)"]
        TVHost["TV Host<br/>(Presenter)"]
        System["System<br/>(Automated)"]
    end

    subgraph AuthUseCases["Authentication"]
        UC1["UC01: Register Account"]
        UC2["UC02: Login"]
        UC3["UC03: Logout"]
        UC4["UC04: Refresh Token"]
        UC5["UC05: Validate Session"]
    end

    subgraph VoteUseCases["Voting"]
        UC10["UC10: Submit Vote"]
        UC11["UC11: Check Vote Status"]
        UC12["UC12: Validate CAPTCHA"]
        UC13["UC13: Prevent Duplicate Vote"]
    end

    subgraph ResultsUseCases["Results"]
        UC20["UC20: View Live Results"]
        UC21["UC21: Stream Real-time Results<br/>(WebSocket)"]
        UC22["UC22: View Final Results"]
        UC23["UC23: Export Results Report"]
    end

    subgraph AdminUseCases["Administration"]
        UC30["UC30: Create Election"]
        UC31["UC31: Manage Candidates"]
        UC32["UC32: Open/Close Voting Window"]
        UC33["UC33: View Detailed Statistics"]
        UC34["UC34: Access Audit Logs"]
        UC35["UC35: Manage Rate Limits"]
    end

    subgraph SystemUseCases["System Operations"]
        UC40["UC40: Process Vote Queue"]
        UC41["UC41: Aggregate Vote Counts"]
        UC42["UC42: Detect Anomalies<br/>(Rule-based)"]
        UC43["UC43: Send to Dead Letter Queue"]
        UC44["UC44: Cross-Region Replication"]
        UC45["UC45: Auto-scale Services"]
    end

    %% Viewer connections
    Viewer --> UC1
    Viewer --> UC2
    Viewer --> UC3
    Viewer --> UC10
    Viewer --> UC11
    Viewer --> UC20
    Viewer --> UC21

    %% Admin connections
    Admin --> UC2
    Admin --> UC30
    Admin --> UC31
    Admin --> UC32
    Admin --> UC33
    Admin --> UC34
    Admin --> UC35
    Admin --> UC22
    Admin --> UC23

    %% TV Host connections
    TVHost --> UC2
    TVHost --> UC21
    TVHost --> UC22
    TVHost --> UC32

    %% System connections
    System --> UC40
    System --> UC41
    System --> UC42
    System --> UC43
    System --> UC44
    System --> UC45

    %% Include relationships
    UC10 -.->|includes| UC12
    UC10 -.->|includes| UC13
    UC10 -.->|includes| UC5

    %% Extend relationships
    UC40 -.->|extends| UC43

    %% Styling
    classDef viewer fill:#e3f2fd,stroke:#1565c0
    classDef admin fill:#fce4ec,stroke:#c2185b
    classDef system fill:#f3e5f5,stroke:#7b1fa2
    classDef tvhost fill:#e8f5e9,stroke:#2e7d32

    class UC1,UC2,UC3,UC10,UC11,UC20,UC21 viewer
    class UC30,UC31,UC32,UC33,UC34,UC35,UC22,UC23 admin
    class UC40,UC41,UC42,UC43,UC44,UC45 system
```

---

## Use Cases Table

### Authentication

| ID | Use Case | Primary Actor | Description | Priority |
|----|----------|----------------|-----------|------------|
| UC01 | Register Account | Viewer | Create account with email/social login via Auth0 | High |
| UC02 | Login | Viewer, Admin, TV Host | Authenticate and receive JWT token | High |
| UC03 | Logout | Viewer | Invalidate session and token | Medium |
| UC04 | Refresh Token | Viewer | Renew expired access token | High |
| UC05 | Validate Session | System | Validate JWT on each request | High |

### Voting

| ID | Use Case | Primary Actor | Description | Priority |
|----|----------|----------------|-----------|------------|
| UC10 | Submit Vote | Viewer | Submit vote for the selected candidate | High |
| UC11 | Check Vote Status | Viewer | Check if the user already voted in the current election | High |
| UC12 | Validate CAPTCHA | System | Validate anti-bot CAPTCHA token | High |
| UC13 | Prevent Duplicate Vote | System | Enforce exactly-once voting | High |

### Results

| ID | Use Case | Primary Actor | Description | Priority |
|----|----------|----------------|-----------|------------|
| UC20 | View Live Results | Viewer | View aggregated results in near real time | High |
| UC21 | Stream Real-time Results | Viewer, TV Host | Receive updates via WebSocket (<1s) | High |
| UC22 | View Final Results | Admin, TV Host | View final results after closing | Medium |
| UC23 | Export Results Report | Admin | Generate PDF/CSV report for audit | Low |

### Administration

| ID | Use Case | Primary Actor | Description | Priority |
|----|----------|----------------|-----------|------------|
| UC30 | Create Election | Admin | Create a new election with candidates | High |
| UC31 | Manage Candidates | Admin | Candidate CRUD | High |
| UC32 | Open/Close Voting Window | Admin, TV Host | Control the voting period | High |
| UC33 | View Detailed Statistics | Admin | Analytics by region, time, etc. | Medium |
| UC34 | Access Audit Logs | Admin | View immutable logs | Medium |
| UC35 | Manage Rate Limits | Admin | Configure throttling by user/IP | Medium |

### System Operations

| ID | Use Case | Primary Actor | Description | Priority |
|----|----------|----------------|-----------|------------|
| UC40 | Process Vote Queue | System | Consume SQS and persist votes | High |
| UC41 | Aggregate Vote Counts | System | Update counters in Redis | High |
| UC42 | Detect Anomalies | System | Identify suspicious patterns (rule-based) | Medium |
| UC43 | Send to Dead Letter Queue | System | Move failed messages to DLQ | High |
| UC44 | Cross-Region Replication | System | Synchronize data across regions | High |
| UC45 | Auto-scale Services | System | Scale ECS tasks based on metrics | High |

---

## Main Flow - Submit Vote (UC10)

```mermaid
sequenceDiagram
    autonumber
    participant V as Viewer
    participant FE as Frontend
    participant GW as API Gateway
    participant Auth as Auth Service
    participant Vote as Vote Service
    participant SQS as SQS Queue
    participant DB as PostgreSQL
    participant Redis as Redis

    V->>FE: Selects candidate and clicks "Vote"
    FE->>FE: Obtains CAPTCHA token
    FE->>GW: POST /api/v1/votes (JWT + CAPTCHA)
    GW->>GW: Rate limit check (per-user)
    GW->>Auth: Validate JWT
    Auth-->>GW: Valid token + userId
    GW->>Vote: Forward request
    Vote->>Vote: Validate CAPTCHA token
    Vote->>Redis: CHECK vote:{electionId}:{userId}
    
    alt Already voted
        Redis-->>Vote: EXISTS = true
        Vote-->>FE: 409 Conflict - Already voted
    else Not voted
        Redis-->>Vote: EXISTS = false
        Vote->>Redis: SET vote:{electionId}:{userId} (TTL 24h)
        Vote->>SQS: SendMessage(votePayload)
        SQS-->>Vote: MessageId
        Vote-->>FE: 200 OK - Vote accepted
        FE-->>V: "Your vote was recorded!"
        
        Note over SQS,DB: Asynchronous processing
        SQS->>Vote: ReceiveMessage (polling)
        Vote->>DB: INSERT INTO votes (...)
        Vote->>Redis: INCR results:{electionId}:{candidateId}
    end
```

---

## Actor Details

| Actor | Description | Authentication | Main Endpoints |
|------|-----------|--------------|---------------------|
| **Viewer** | Viewer voting during the live show | JWT via Auth0 | `/auth/*`, `/votes/*`, `/results/*` |
| **Admin** | Backoffice operator | JWT + Admin role | `/admin/*`, `/elections/*`, `/audit/*` |
| **TV Host** | Host who controls the live voting window | JWT + Host role | `/elections/control/*`, `/results/stream/*` |
| **System** | Automated processes | Internal (no auth) | SQS consumers, schedulers |

---

## Use Case Relationships

| Type | From | To | Description |
|------|-----|------|-----------|
| **includes** | UC10 (Submit Vote) | UC12 (Validate CAPTCHA) | Every vote requires CAPTCHA validation |
| **includes** | UC10 (Submit Vote) | UC13 (Prevent Duplicate) | Every vote checks for duplicates |
| **includes** | UC10 (Submit Vote) | UC05 (Validate Session) | Every vote requires a valid session |
| **extends** | UC40 (Process Queue) | UC43 (Send to DLQ) | Repeated failures go to the DLQ |
